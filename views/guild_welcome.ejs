<%- include('header', { user: user, guild: guild, activePage: 'welcome' }) %>

<div class="main-content">
    <h1>üëã Configura√ß√£o de Boas-Vindas e Sa√≠da</h1>
    <p>Configure a mensagem que ser√° enviada quando um novo membro entrar. Use Placeholders como: <code>{mention}</code>, <code>{user}</code>, <code>{guild}</code> e <code>{count}</code>.</p>

    <form id="welcome-config-form" action="/dashboard/<%= guild.id %>/welcome/save" method="POST">
        
        <div class="config-section status-toggle-group">
            <span class="config-label">Status da Mensagem de Boas-Vindas:</span>
            <div class="toggle-switch">
                <input type="checkbox" id="enabled" name="enabled" <%= config.enabled ? 'checked' : '' %>>
                <label for="enabled" class="toggle-label"></label>
            </div>
        </div>

        <div class="config-section">
            <label for="channelId">Canal de Envio:</label>
            <select id="channelId" name="channelId" class="input-full">
                <option value="none">Desativado / Selecione um Canal de Texto...</option>
                <% channels.forEach(c => { %>
                    <option value="<%= c.id %>" <%= config.channelId === c.id ? 'selected' : '' %>>
                        #<%= c.name %>
                    </option>
                <% }); %>
            </select>
        </div>

        <div class="config-section">
            <h2>Mensagem de Texto Simples</h2>
            <p class="helper-text">Esta mensagem √© enviada **acima** do Embed (m√°x. 2000 caracteres).</p>
            <label for="text">Conte√∫do da Mensagem:</label>
            <textarea id="text" name="text" rows="2" class="input-full"><%= config.text || '' %></textarea>
        </div>

        <div class="config-section embed-container">
            <div class="header-with-toggle">
                <h2>Configura√ß√£o de Embed</h2>
                <div class="toggle-switch small-toggle">
                    <input type="checkbox" id="embedEnabled" name="embedEnabled" <%= config.embed.enabled ? 'checked' : '' %>>
                    <label for="embedEnabled" class="toggle-label"></label>
                </div>
            </div>

            <div class="embed-fields">
                <label for="embedTitle">T√≠tulo:</label>
                <input type="text" id="embedTitle" name="embedTitle" value="<%= config.embed.title || '' %>" class="input-full" maxlength="256">
                
                <label for="embedDescription">Descri√ß√£o (Corpo da Mensagem):</label>
                <textarea id="embedDescription" name="embedDescription" rows="4" class="input-full"><%= config.embed.description || '' %></textarea>
                
                <label for="embedColor">Cor da Barra Lateral (Hex):</label>
                <input type="color" id="embedColor" name="embedColor" value="<%= config.embed.color || '#5865F2' %>" class="input-color">

                <label for="embedFooterText">Rodap√© (Footer):</label>
                <input type="text" id="embedFooterText" name="embedFooterText" value="<%= config.embed.footerText || '' %>" class="input-full" maxlength="2048">

                <div class="status-toggle-group">
                    <span class="config-label">Incluir Avatar do Usu√°rio (Thumbnail):</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="embedThumbnail" name="embedThumbnail" <%= config.embed.thumbnail ? 'checked' : '' %>>
                        <label for="embedThumbnail" class="toggle-label"></label>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">üíæ Salvar Configura√ß√µes</button>
        <div id="message-status" class="status-message"></div>
    </form>
</div>

<%- include('footer') %>

<script>
    // L√≥gica AJAX para salvar (garante que a p√°gina n√£o recarregue)
    document.getElementById('welcome-config-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target;
        // Pega todos os dados, incluindo checkboxes
        const formData = new URLSearchParams(new FormData(form)).toString();
        const statusDiv = document.getElementById('message-status');

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData,
            });
            const result = await response.json();
            
            statusDiv.textContent = result.message;
            statusDiv.className = result.success ? 'status-message success' : 'status-message error';
            setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = 'status-message'; }, 5000);
            
        } catch (error) {
            statusDiv.textContent = '‚ùå Erro ao salvar: Ocorreu um problema de conex√£o.';
            statusDiv.className = 'status-message error';
        }
    });
</script>