<!DOCTYPE html>
<html>
<head>
    <title>Configurar <%= guild.name %></title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #2c2f33; color: #ffffff; padding: 20px; }
        .header { background-color: #7289da; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        
        /* NOVO: Estilos para o Layout e Sidebar */
        .dashboard-layout { display: flex; gap: 20px; }
        .sidebar { width: 250px; background-color: #23272a; padding: 20px; border-radius: 8px; height: fit-content; }
        .main-content { flex-grow: 1; background-color: #23272a; padding: 20px; border-radius: 8px; }

        /* Perfil na Sidebar */
        .profile-box { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #36393f; }
        .profile-box img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .profile-box h4 { margin: 0; color: #7289da; }
        .profile-box p { margin: 5px 0 0 0; font-size: 0.8em; opacity: 0.7; }

        .menu a { color: #ffffff; margin-right: 15px; text-decoration: none; }
        h1, h2 { color: #ffffff; }
        
        /* Abas */
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #36393f; }
        .tab-button { 
            padding: 10px 15px; 
            cursor: pointer; 
            border: none; 
            background-color: transparent; 
            color: #ccc; 
            font-weight: bold;
            transition: color 0.2s;
        }
        .tab-button:hover { color: #fff; }
        .tab-button.active { 
            color: #7289da; 
            border-bottom: 3px solid #7289da; 
            margin-bottom: -2px; 
        }
        .tab-content { padding-top: 15px; }

        /* Configura√ß√µes Comuns */
        .config-section { background-color: #36393f; padding: 15px; border-radius: 5px; margin-top: 15px; }
        select, input[type="text"], textarea { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            margin-bottom: 15px;
            border-radius: 5px; 
            border: 1px solid #5a5a5a;
            background-color: #2c2f33;
            color: #ffffff;
            box-sizing: border-box; 
        }
        .current-setting { font-weight: bold; color: #2ecc71; }
        
        /* Bot√µes e Alertas */
        button { padding: 10px 15px; margin-top: 10px; border-radius: 5px; border: none; background-color: #7289da; color: white; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: #677bc4; }
        .status-message { padding: 10px; margin-top: 10px; border-radius: 5px; color: white; display: none; }
        .danger-button { background-color: #e74c3c; margin-left: 10px; }
        .danger-button:hover { background-color: #c0392b; }
        .test-button { background-color: #f39c12; margin-left: 10px; }
        .test-button:hover { background-color: #e67e22; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Configura√ß√£o: <%= guild.name %></h1>
    </div>

    <div class="dashboard-layout">
        
        <div class="sidebar">
            <div class="profile-box">
                <% 
                    const avatarId = user.avatar;
                    const avatarURL = avatarId 
                        ? `https://cdn.discordapp.com/avatars/${user.id}/${avatarId}.${avatarId.startsWith('a_') ? 'gif' : 'png'}?size=128` 
                        : `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5}.png`;
                %>
                <img src="<%= avatarURL %>" alt="Avatar" class="profile-avatar">
                <h4><%= user.username %></h4>
                <p>ID: <code><%= user.id %></code></p>
            </div>

            <div class="menu-items">
                 <a href="/dashboard">üè† Painel Inicial</a>
                 <a href="/logout" style="color: #e74c3c;">üö™ Sair (Logout)</a>
            </div>
        </div>

        <div class="main-content">
            
            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'autorole')">Auto-Role</button>
                <button class="tab-button" onclick="openTab(event, 'notifications')">Notifica√ß√£o de Entrar/Sair</button>
                <button class="tab-button" onclick="openTab(event, 'logs')">Event Logs (Em Breve)</button>
            </div>

            <div id="autorole" class="tab-content">
                <h2>üõ†Ô∏è Auto-Role (Cargo Autom√°tico)</h2>
                <div class="config-section">
                    <p>
                        Cargo atual: 
                        <% if (currentAutoroleId && guild.roles.cache.has(currentAutoroleId)) { %>
                            <span class="current-setting">@<%= guild.roles.cache.get(currentAutoroleId).name %></span>
                        <% } else { %>
                            <span class="current-setting" style="color: yellow;">Nenhum (Desativado)</span>
                        <% } %>
                    </p>
                    
                    <form id="autorole-form">
                        <label for="autorole-select">Selecione o cargo que novos membros receber√£o:</label><br>
                        <select id="autorole-select" name="roleId">
                            <option value="none">-- DESATIVAR Auto-Role --</option>
                            <% roles.forEach(role => { %>
                                <option value="<%= role.id %>" <%= role.id === currentAutoroleId ? 'selected' : '' %>>
                                    <%= role.name %>
                                </option>
                            <% }); %>
                        </select>
                        <button type="submit">Salvar Auto-Role</button>
                    </form>
                    
                    <div id="autorole-status" class="status-message"></div>
                </div>
            </div>

            <div id="notifications" class="tab-content" style="display: none;">
                <h2>üîî Notifica√ß√£o de Entrada/Sa√≠da</h2>
                <div class="config-section">
                    
                    <p>
                        Entrada (Join): 
                        <% if (joinChannelId && guild.channels.cache.has(joinChannelId)) { %>
                            <span class="current-setting">#<%= guild.channels.cache.get(joinChannelId).name %> (<%= joinEmbed ? 'Embed' : 'Texto' %>)</span>
                        <% } else { %>
                            <span class="current-setting" style="color: yellow;">Desativado</span>
                        <% } %>
                    </p>
                    <p>
                        Sa√≠da (Leave): 
                        <% if (leaveChannelId && guild.channels.cache.has(leaveChannelId)) { %>
                            <span class="current-setting">#<%= guild.channels.cache.get(leaveChannelId).name %> (<%= leaveEmbed ? 'Embed' : 'Texto' %>)</span>
                        <% } else { %>
                            <span class="current-setting" style="color: yellow;">Desativado</span>
                        <% } %>
                    </p>

                    <form id="notifications-form">
                        <hr style="border-color: #5a5a5a;">
                        <h3>Configura√ß√£o de Entrada (Join)</h3>
                        <label for="join-channel-select">Canal de Texto para Boas-Vindas:</label><br>
                        <select id="join-channel-select" name="joinChannelId">
                            <option value="none">-- DESATIVAR Notifica√ß√£o de Entrada --</option>
                            <% textChannels.forEach(channel => { %>
                                <option value="<%= channel.id %>" <%= channel.id === joinChannelId ? 'selected' : '' %>>
                                    #<%= channel.name %>
                                </option>
                            <% }); %>
                        </select>

                        <label for="join-msg">Mensagem de Boas-Vindas (Use {mention}, {user}, {guild}, {count}):</label><br>
                        <textarea id="join-msg" name="joinMessage" rows="3"><%= joinMsg %></textarea>
                        
                        <label style="margin-right: 15px;">
                            <input type="checkbox" name="joinEmbed" value="true" <%= joinEmbed ? 'checked' : '' %>> Enviar como **Embed**
                        </label>
                        <button type="button" class="test-button" onclick="testJoinMessage()">Testar Entrada</button>

                        <hr style="border-color: #5a5a5a; margin-top: 20px;">
                        <h3>Configura√ß√£o de Sa√≠da (Leave)</h3>
                        <label for="leave-channel-select">Canal de Texto para Despedidas:</label><br>
                        <select id="leave-channel-select" name="leaveChannelId">
                            <option value="none">-- DESATIVAR Notifica√ß√£o de Sa√≠da --</option>
                            <% textChannels.forEach(channel => { %>
                                <option value="<%= channel.id %>" <%= channel.id === leaveChannelId ? 'selected' : '' %>>
                                    #<%= channel.name %>
                                </option>
                            <% }); %>
                        </select>

                        <label for="leave-msg">Mensagem de Despedida (Use {user}, {guild}, {count}):</label><br>
                        <textarea id="leave-msg" name="leaveMessage" rows="3"><%= leaveMsg %></textarea>
                        
                        <label>
                            <input type="checkbox" name="leaveEmbed" value="true" <%= leaveEmbed ? 'checked' : '' %>> Enviar como **Embed**
                        </label>
                        
                        <button type="submit" style="margin-top: 20px;">Salvar TODAS as Notifica√ß√µes</button>
                    </form>
                    
                    <div id="notifications-status" class="status-message"></div>
                    
                    <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">
                        **Vari√°veis dispon√≠veis:** <ul>
                            <li>`{mention}`: Menciona o usu√°rio (Entrada apenas)</li>
                            <li>`{user}`: Nome de usu√°rio (Ex: wengleeyy\_tr)</li>
                            <li>`{guild}`: Nome do servidor</li>
                            <li>`{count}`: N√∫mero total de membros</li>
                        </ul>
                    </p>
                </div>
            </div>

            <div id="logs" class="tab-content" style="display: none;">
                <h2>üìù Event Logs</h2>
                <p>Esta funcionalidade ainda ser√° desenvolvida. Volte em breve!</p>
            </div>
        </div>
        
    </div> <script>
        // Fun√ß√£o para mudar de aba
        function openTab(evt, tabName) {
            const contents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].style.display = "none";
            }
            
            const buttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].className = buttons[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // --- FUN√á√ÉO DE ENVIO (AJAX) ---
        async function submitForm(endpoint, jsonBody, statusDivId, successCallback) {
            const statusDiv = document.getElementById(statusDivId);

            statusDiv.style.display = 'none';
            statusDiv.style.backgroundColor = '';

            try {
                const response = await fetch(`/dashboard/<%= guild.id %>/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonBody)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusDiv.style.backgroundColor = '#2ecc71'; // Verde
                    statusDiv.innerHTML = `‚úÖ Sucesso! ${data.message}`;
                    if (successCallback) successCallback(jsonBody);
                } else {
                    statusDiv.style.backgroundColor = '#e74c3c'; // Vermelho
                    statusDiv.innerHTML = `‚ùå Erro: ${data.message}`;
                }
            } catch (error) {
                statusDiv.style.backgroundColor = '#e74c3c'; // Vermelho
                statusDiv.innerHTML = `‚ùå Erro de Conex√£o: Ocorreu um problema ao enviar dados.`;
                console.error('Fetch error:', error);
            }
            
            statusDiv.style.display = 'block';
        }
        
        // --- L√ìGICA AUTO-ROLE ---
        document.getElementById('autorole-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const jsonBody = { roleId: form.elements.roleId.value };
            
            submitForm('autorole', jsonBody, 'autorole-status', (jsonBody) => {
                const currentRoleSpan = document.querySelector('#autorole .current-setting');
                
                if (jsonBody.roleId === 'none') {
                    currentRoleSpan.innerHTML = 'Nenhum (Desativado)';
                    currentRoleSpan.style.color = 'yellow';
                } else {
                    const selectedRoleText = form.elements.roleId.options[form.elements.roleId.selectedIndex].text;
                    currentRoleSpan.innerHTML = `@${selectedRoleText.trim()}`;
                    currentRoleSpan.style.color = '#2ecc71';
                }
            });
        });

        // --- L√ìGICA NOTIFICA√á√ïES ---
        document.getElementById('notifications-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            
            // Re√∫ne dados do formul√°rio
            const jsonBody = { 
                joinChannelId: form.elements.joinChannelId.value,
                leaveChannelId: form.elements.leaveChannelId.value,
                joinMessage: form.elements.joinMessage.value,
                leaveMessage: form.elements.leaveMessage.value,
                // Checkboxes: Envia 'true' se marcado, sen√£o 'false'.
                joinEmbed: form.elements.joinEmbed.checked ? 'true' : 'false',
                leaveEmbed: form.elements.leaveEmbed.checked ? 'true' : 'false'
            };
            
            submitForm('notifications', jsonBody, 'notifications-status', (jsonBody) => {
                // Callback para atualizar o texto de status
                const joinStatus = jsonBody.joinChannelId !== 'none' ? `#${form.elements.joinChannelId.options[form.elements.joinChannelId.selectedIndex].text} (${jsonBody.joinEmbed === 'true' ? 'Embed' : 'Texto'})` : 'Desativado';
                const leaveStatus = jsonBody.leaveChannelId !== 'none' ? `#${form.elements.leaveChannelId.options[form.elements.leaveChannelId.selectedIndex].text} (${jsonBody.leaveEmbed === 'true' ? 'Embed' : 'Texto'})` : 'Desativado';
                
                // Atualiza o status visual
                document.querySelector('#notifications p:nth-child(2) .current-setting').innerHTML = joinStatus;
                document.querySelector('#notifications p:nth-child(4) .current-setting').innerHTML = leaveStatus;
                
                document.querySelector('#notifications p:nth-child(2) .current-setting').style.color = joinStatus === 'Desativado' ? 'yellow' : '#2ecc71';
                document.querySelector('#notifications p:nth-child(4) .current-setting').style.color = leaveStatus === 'Desativado' ? 'yellow' : '#2ecc71';
            });
        });
        
        // --- TESTE DE MENSAGEM ---
        function testJoinMessage() {
            const channelId = document.getElementById('join-channel-select').value;
            const joinMessage = document.getElementById('join-msg').value;
            const isEmbed = document.querySelector('input[name="joinEmbed"]').checked ? 'true' : 'false';
            const statusDiv = document.getElementById('notifications-status');
            
            if (channelId === 'none') {
                 statusDiv.style.backgroundColor = '#e74c3c'; // Vermelho
                 statusDiv.innerHTML = `‚ùå Erro: Selecione um canal de Entrada antes de testar.`;
                 statusDiv.style.display = 'block';
                 return;
            }

            const jsonBody = { 
                channelId: channelId, 
                joinMessage: joinMessage,
                isEmbed: isEmbed 
            };

            submitForm('test_join_message', jsonBody, 'notifications-status');
        }
        
        // Abre a primeira aba ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            const firstButton = document.querySelector('.tab-button');
            if (firstButton) {
                firstButton.click();
            }
        });
    </script>
</body>
</html>